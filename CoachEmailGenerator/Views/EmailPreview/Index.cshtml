@model dynamic
@{
    ViewData["Title"] = "Preview Emails";
    var pic = User?.Claims.FirstOrDefault(x => x.Type == "urn:google:picture").Value;

    List<School> schools = Model.Schools;
    EmailTemplate template = Model.Template;

    var createdSuccessfully = (TempData["CreatedEmail"] != null) ? TempData["CreatedEmail"].ToString() : string.Empty;
    TempData["CreatedEmail"] = null;  // clear it out

    // Modify the EmailSubjectLine for the preview page for proper behavior
    var subjectLine = template.EmailSubjectLine;
    var results = subjectLine.Split('[', ']').Where((item, index) => index % 2 != 0).Select(x => '[' + x + ']').ToList();

    foreach (var item in results)
    {
        // get the right tag
        var tag = item.ToUpper() switch
        {
            var x when
            x == "[SCHOOL]" => "school-name",
            "[SCHOOL NAME SHORT]" => "school-name-short",
            "[COACH NAME]" => "coach-name",
            "[COACH EMAIL]" => "coach-email",
            "[COACH PHONE]" => "coach-phone",
            _ => ""
        };

        subjectLine = subjectLine.Replace(item, $@"<span class=""coach-button"" data-school-info=""{tag}"">{item}</span>");
    }
}

<form asp-route="Index" method="post">

    <div class="container">
        <div class="row">
            <div class="col">
                @if (!string.IsNullOrEmpty(createdSuccessfully))
                {
                    <span class="bg-success">@createdSuccessfully</span>
                }

                @foreach (var school in schools.Where(x => x.IsEnabled == true))
                {
                    <div class="school-item-preview"
                         data-school-name="@school.SchoolName"
                         data-school-name-short="@school.SchoolNameShort"
                         data-coach-name="@school.CoachName"
                         data-coach-email="@school.CoachEmail"
                         data-coach-phone="@school.CoachPhoneNumber">
                        <span class="school">@school.SchoolName</span>
                        <span class="coach">Coach @school.CoachName</span>
                    </div>
                }
            </div>
            <div class="col-8">

                <div class="preview-pane">
                    <div class="email-header">
                        <div class="header-row">
                            <label>From:</label>
                            <span class="header-item from">@template.EmailAddress</span>
                        </div>
                        <div class="header-row">
                            <label>To:</label>
                            <span class="header-item to">[COACH TO]</span>
                        </div>
                        <div class="header-row">
                            <label>Subject:</label>
                            <span class="header-item subject">@Html.Raw(subjectLine)</span>
                        </div>
                    </div>

                    <div class="email-body">
                        @Html.Raw(template.EmailBody)
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="buttons row">
        <div class="col">
            <button type="button" class="btn btn-outline-primary">
                <span class="far fa-arrow-to-left"></span>
                PREV
            </button>
        </div>
        <div class="col text-right">
            <button type="submit" class="btn btn-primary">
                SEND EMAIL
            </button>
        </div>
    </div>
</form>


@section Scripts {
    <script>
        $(document).ready(function () {

            var _schoolNameEl = document.querySelector(".coach-button[data-school-info='school-name']");
            var _schoolNameDefaultVal = (_schoolNameEl) ? _schoolNameEl.innerText : undefined;
            var _schoolNameShortEl = document.querySelector(".coach-button[data-school-info='school-name-short']");
            var _schoolNameShortDefaultVal = (_schoolNameShortEl) ? _schoolNameShortEl.innerText : undefined;
            var _coachNameEl = document.querySelector(".coach-button[data-school-info='coach-name']");
            var _coachNameDefaultVal = (_coachNameEl) ? _coachNameEl.innerText : undefined;
            var _coachEmailEl = document.querySelector(".coach-button[data-school-info='coach-email']");
            var _coachEmailDefaultVal = (_coachEmailEl) ? _coachEmailEl.innerText : undefined;
            var _coachPhoneEl = document.querySelector(".coach-button[data-school-info='coach-phone']");
            var _coachPhoneDefaultVal = (_coachPhoneEl) ? _coachPhoneEl.innerText : undefined;
            var _coachEmailHeaderDefaultVal = $(".preview-pane .email-header .header-row .to").innerText;

            $(".school-item-preview").hover(function () { // mouse over
                var $this = this;
                var dataItems = [
                    'school-name',
                    'school-name-short',
                    'coach-name',
                    'coach-email',
                    'coach-phone'];

                dataItems.forEach(function (dataItem) {
                    document.querySelectorAll(".coach-button[data-school-info='" + dataItem + "']").forEach(function (item) {
                        replaceDefaultValWithValue(item, $($this).data(dataItem));
                    });
                });

                var coachRegEx = $(this).data("coach-name").match("[^ ]* (.*)");
                if (coachRegEx && coachRegEx.length >= 1) _coachNameEl.innerText = "Coach " + coachRegEx[1];

                $(".preview-pane .email-header .header-row .to").text($(this).data("coach-email"));


            }, function () {  //mouse out

                var defaultVals = [
                    { 'name': 'school-name', 'defaultVal': _schoolNameDefaultVal },
                    { 'name': 'school-name-short', 'defaultVal': _schoolNameShortDefaultVal },
                    { 'name': 'coach-name', 'defaultVal': _coachNameDefaultVal },
                    { 'name': 'coach-email', 'defaultVal': _coachEmailDefaultVal },
                    { 'name': 'coach-phone', 'defaultVal': _coachPhoneDefaultVal }];

                for (const [key, value] of Object.entries(defaultVals)) {
                    document.querySelectorAll(".coach-button[data-school-info='" + value.name + "']").forEach(function (item) {
                        replaceValueWithDefaultVal(item, value.defaultVal);
                    });
                }

                $(".preview-pane .email-header .header-row .to").text(_coachEmailHeaderDefaultVal);

            });

            function replaceDefaultValWithValue(el, value) {
                el.innerText = value;
                el.classList.add("hover-val");
            }

            function replaceValueWithDefaultVal(el, value) {
                el.innerText = value;
                el.classList.remove("hover-val");
            }


        });

    </script>
}